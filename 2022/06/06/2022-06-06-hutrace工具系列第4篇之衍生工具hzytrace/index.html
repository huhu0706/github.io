<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.2">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;hutrace的功能已经实现的比较全面了，dynamroio与pin虽然在对程序的分析处理上各有一定的优势，但是实际中测试下来dynamorio在Linux下的兼容性要比pin稍微差一点，存在一些无法用hutrace记录但pin可以追踪的情况，而且pin提供的接口功能也更丰富，故基于pin完成了大部分hutrac">
<meta name="keywords" content="工具,调试器,hutrace,Linux,pin,hzytrace">
<meta property="og:type" content="article">
<meta property="og:title" content="2022-06-06-hutrace工具系列第4篇之衍生工具hzytrace">
<meta property="og:url" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;index.html">
<meta property="og:site_name" content="huhu&#39;s blog">
<meta property="og:description" content="&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;hutrace的功能已经实现的比较全面了，dynamroio与pin虽然在对程序的分析处理上各有一定的优势，但是实际中测试下来dynamorio在Linux下的兼容性要比pin稍微差一点，存在一些无法用hutrace记录但pin可以追踪的情况，而且pin提供的接口功能也更丰富，故基于pin完成了大部分hutrac">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;%E5%9B%BE%E7%89%872.png">
<meta property="og:image" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;%E5%9B%BE%E7%89%873.png">
<meta property="og:image" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;%E5%9B%BE%E7%89%874.png">
<meta property="og:image" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;%E5%9B%BE%E7%89%875.png">
<meta property="og:updated_time" content="2022-06-06T13:15:31.292Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;huhu0706.github.io&#x2F;2022&#x2F;06&#x2F;06&#x2F;2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace&#x2F;%E5%9B%BE%E7%89%872.png">

<link rel="canonical" href="https://huhu0706.github.io/2022/06/06/2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>2022-06-06-hutrace工具系列第4篇之衍生工具hzytrace | huhu's blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">huhu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/huhu0706" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://huhu0706.github.io/2022/06/06/2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC4%E7%AF%87%E4%B9%8B%E8%A1%8D%E7%94%9F%E5%B7%A5%E5%85%B7hzytrace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/main.gif">
      <meta itemprop="name" content="huhu">
      <meta itemprop="description" content="悟已往之不谏、知来者之可追">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="huhu's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2022-06-06-hutrace工具系列第4篇之衍生工具hzytrace
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-06 15:00:00 / 修改时间：21:15:31" itemprop="dateCreated datePublished" datetime="2022-06-06T15:00:00+08:00">2022-06-06</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <center>
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" 
    src=图片1.png>
    <br>
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;"></div>
</center>

<blockquote>
<p>&ensp;&ensp;&ensp;&ensp;hutrace的功能已经实现的比较全面了，dynamroio与pin虽然在对程序的分析处理上各有一定的优势，但是实际中测试下来dynamorio在Linux下的兼容性要比pin稍微差一点，存在一些无法用hutrace记录但pin可以追踪的情况，而且pin提供的接口功能也更丰富，故基于pin完成了大部分hutrace的功能，也即是下面要介绍的hzytrace工具。hzytrace目前仅支持linux平台，windows平台上基于dynamrio的hutrace在效率、兼容性上均优于pin，暂时就还没完善window下的hzytrace。
</blockquote>
<a id="more"></a>

<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>hzytrace本身基于pin+codapintracer开发，原codapintracer仅支持Windows平台的API记录（类似drltrace），代码基于Window做了特别多的处理（所以hzytrace移植到win上比较简单…），功能也很多，导致移植到linux多了很多坑，而且在linux下pin的对程序的处理接口也存在一些问题，最终魔改完的代码快没法看了。。不过整体来说hzytrace的功能性还可以，可作为hutrace在处理一些Linux程序上的补充，本篇先介绍下hzytrace的基本功能，最后将结合一些实例进行演示。</p>
<h2 id="2-基本功能"><a href="#2-基本功能" class="headerlink" title="2. 基本功能"></a>2. 基本功能</h2><p>hzytrace支持的基本功能参数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-bbllog     [default true]      打印所有执行基本块的汇编指令</span><br><span class="line">-forklog    [default true]      默认追踪fork的子进程</span><br><span class="line">-syscall    [default true]      默认追踪进程的syscall调用</span><br><span class="line">-inslog     [default false]     打印所有执行指令的运行状态信息</span><br><span class="line">-logstart   [default false]     指定记录的指令开始地址</span><br><span class="line">-logend     [default false]     指定记录的指令结束地址</span><br><span class="line">-target     [default -]         指定需要记录的模块名</span><br><span class="line">-allimage   [default false]     记录所有模块的运行</span><br></pre></td></tr></table></figure>
<p>默认情况下，hzytrace会记录程序的API调用、Syscall调用以及所有的基本块转移记录，下面结合一些实例的记录信息进行介绍。</p>
<h3 id="2-1-基本块汇编指令打印"><a href="#2-1-基本块汇编指令打印" class="headerlink" title="2.1 基本块汇编指令打印"></a>2.1 基本块汇编指令打印</h3><p>在hzytrace目录中执行下述指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># huhu @ huhu in ~/Desktop/pin-3.5 [3:12:07] </span><br><span class="line">$ ./pin -t hzytrace.so -bbllog  -- ls -al </span><br><span class="line">[INFO] Configuring Pintool</span><br><span class="line">[INFO] Starting instrumented program</span><br><span class="line"></span><br><span class="line">Load Image:/bin/ls Base:400000-41da63</span><br><span class="line">setMainIMGAddress:400000 41da63</span><br><span class="line">Load Image:/lib64/ld-linux-x86-64.so.2 Base:7f8438bd4000-7f8438bf93af</span><br><span class="line">Load Image:[vdso] Base:7ffdde88b000-7ffdde88c02a</span><br><span class="line">[INFO] Opening file</span><br><span class="line">./Results/2022_05_21_03_07_08//TRACER/hzytrace.ls.11596.0.1653120428.out</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libselinux.so.1 Base:7f84252b9000-7f84254da6df</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libc.so.6 Base:7f8424ec2000-7f842528b99f</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libpcre.so.3 Base:7f8424c4b000-7f8424eba107</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libdl.so.2 Base:7f8424a2f000-7f8424c320ef</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libpthread.so.0 Base:7f8424811000-7f8424a2d427</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libnss_compat.so.2 Base:7f8423474000-7f842367c45f</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libnsl.so.1 Base:7f8423256000-7f842346ea57</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libnss_nis.so.2 Base:7f8422f82000-7f842318d587</span><br><span class="line">Load Image:/lib/x86_64-linux-gnu/libnss_files.so.2 Base:7f8422d6b000-7f8422f7c717</span><br><span class="line"></span><br><span class="line">//以上为hzytrace打印的调试信息</span><br><span class="line"></span><br><span class="line">total 6228</span><br><span class="line">drwxr-x---  4 huhu huhu    4096 May 21 03:07 .</span><br><span class="line">drwxr-x--- 48 huhu huhu    4096 May 21 02:50 ..</span><br><span class="line">//省略部分ls结果显示</span><br></pre></td></tr></table></figure>

<p>查看Results目录下记录的trace日志内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">C0x4049c4|0x402640                      </span><br><span class="line"></span><br><span class="line">//C0x4049c4对应下面ida中ls程序反汇编结果</span><br><span class="line">//.text:00000000004049AF mov     r8, offset fini ; fini</span><br><span class="line">//.text:00000000004049B6 mov     rcx, offset init ; init</span><br><span class="line">//.text:00000000004049BD mov     rdi, offset main ; main</span><br><span class="line">//.text:00000000004049C4 call    ___libc_start_main</span><br><span class="line"></span><br><span class="line">B0x402640|0x402640</span><br><span class="line">	D0x402640|jmp qword ptr [rip+0x21bb7a]</span><br><span class="line">B0x402646|0x40264b</span><br><span class="line">	D0x402646|push 0x35</span><br><span class="line">	D0x40264b|jmp 0x4022e0</span><br><span class="line">B0x4022e0|0x4022e6</span><br><span class="line">	D0x4022e0|push qword ptr [rip+0x21bd22]</span><br><span class="line">	D0x4022e6|jmp qword ptr [rip+0x21bd24]</span><br><span class="line">J0x4022e6|0x7f15489d0f10</span><br><span class="line"></span><br><span class="line">//hzytrace_linux.config未配置的函数默认打印四个参数</span><br><span class="line">~~16451~~ libc.so.6!__libc_start_main N:0x1</span><br><span class="line">	arg 0: 0x402a00</span><br><span class="line">	arg 1: 0x2</span><br><span class="line">	arg 2: 0x7ffda586d668</span><br><span class="line">	arg 3: 0x413bb0</span><br><span class="line"></span><br><span class="line">//ls的init</span><br><span class="line">B0x413bb0|0x413bdc                  </span><br><span class="line">	D0x413bb0|push r15</span><br><span class="line">	D0x413bb2|push r14</span><br><span class="line">	D0x413bb4|mov r15d, edi</span><br><span class="line">	D0x413bb7|push r13</span><br><span class="line">	D0x413bb9|push r12</span><br><span class="line">	D0x413bbb|lea r12, ptr [rip+0x20a23e]</span><br><span class="line">	D0x413bc2|push rbp</span><br><span class="line">	D0x413bc3|lea rbp, ptr [rip+0x20a23e]</span><br><span class="line">	D0x413bca|push rbx</span><br><span class="line">	D0x413bcb|mov r14, rsi</span><br><span class="line">	D0x413bce|mov r13, rdx</span><br><span class="line">	D0x413bd1|sub rbp, r12</span><br><span class="line">	D0x413bd4|sub rsp, 0x8</span><br><span class="line">	D0x413bd8|sar rbp, 0x3</span><br><span class="line">	D0x413bdc|call 0x4022b8</span><br><span class="line">C0x413bdc|0x4022b8</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">//hzytrace_linux.config配置的函数根据设置的参数类型的打印参数信息</span><br><span class="line">~~16451~~ libc.so.6!__lxstat N:0x25b</span><br><span class="line">	arg 0: 0x1</span><br><span class="line">	arg 1: 0x7ffda586ce00</span><br><span class="line">	arg 2: 0x246d3e0</span><br><span class="line">	arg 3: 0x2</span><br><span class="line">~~16451~~ libc.so.6!__lxstat64 N:0x25c</span><br><span class="line"> 	arg 0: 0x1 (type=int, size=0x4)</span><br><span class="line"> 	arg 1: pintool.log (type=char*, size=0x0)</span><br><span class="line"> 	arg 2:  (type=char*, size=0x0)</span><br><span class="line">S|lstat:6</span><br><span class="line">   executed libc.so.6!__lxstat returnIp:0x4080c9 =&gt;</span><br><span class="line">	retval: 0x0</span><br><span class="line">   executed libc.so.6!__lxstat64 returnIp:0x4080c9 =&gt;</span><br><span class="line"> 	retval: 0x0 (type=int, size=0x4)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>显示功能基本与hutrace保持一致，同时支持hex以及struct打印，除后面介绍的hook、dump功能上（不支持hutrace的简易patch、hide功能），hzytrace_linux.config与hutrace.config在API参数打印上的设置基本一致。</p>
<p>如果不需要打印基本块对应的汇编指令，可以设置bbllog参数的值为false：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -bbllog  0 -- ls -al</span><br></pre></td></tr></table></figure>
<p>trace结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C0x4049c4|0x402640</span><br><span class="line">J0x4022e6|0x7f93f9a77f10</span><br><span class="line">~~16821~~ libc.so.6!__libc_start_main N:0x1</span><br><span class="line">	arg 0: 0x402a00</span><br><span class="line">	arg 1: 0x2</span><br><span class="line">	arg 2: 0x7ffda07a5b88</span><br><span class="line">	arg 3: 0x413bb0</span><br><span class="line">C0x413bdc|0x4022b8</span><br><span class="line">R0x4022d1|0x413be1</span><br><span class="line">C0x413bf9|0x404a70</span><br><span class="line">R0x404a49|0x413bfd</span><br><span class="line">R0x413c14|0x7f93e5d6e7cf</span><br></pre></td></tr></table></figure>
<p>注意开启bbllog的trace日志中会打印出所有ls主程序中执行的代码，而在上述不开启bbllog的trace日志结果中，并不会记录到跳转到main函数0x402A00地址的信息，因为并非是从ls主程序中执行的指令跳转进入的main函数。</p>
<ul>
<li>一个小bug：在ls等程序运行加载libc.so.6进行初始化时，pin无法获取到初始化代码的模块名称，而hzytrace记录时会默认记录不在任意模块内的代码，导致trace日志开头会存在一小部分libc.so代码的冗余，后面的trace日志中不会再出现该情况。</li>
</ul>
<h3 id="2-2-syscall记录"><a href="#2-2-syscall记录" class="headerlink" title="2.2 syscall记录"></a>2.2 syscall记录</h3><p>功能及使用方式与hutrace类似，默认情况下只打印执行的syscall的名称，在hzytrace_linux.config文件中设置参数信息后才会根据参数类型打印对应的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int|syscall_read|LONG|__out hex^ARG2|int</span><br><span class="line">int|syscall_write|LONG|char *</span><br><span class="line">int|syscall_open|char *|LONG</span><br></pre></td></tr></table></figure>

<p>trace记录样例(运行过程中所有syscall)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -syscall -- ls -al</span><br></pre></td></tr></table></figure>

<p>分析trace的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">S|brk:12</span><br><span class="line">S|access:21</span><br><span class="line">S|access:21</span><br><span class="line">S|open:2</span><br><span class="line">SysEnter|syscall_open|0x7f5ec45d41d1|0x80000|</span><br><span class="line"> 	arg 0: /etc/ld.so.cache (type=char*, size=0x0)</span><br><span class="line"> 	arg 1: 0x80000 (type=long, size=0x8)</span><br><span class="line">SysExit|open</span><br><span class="line">S|fstat:5</span><br><span class="line">S|mmap:9</span><br><span class="line">S|close:3</span><br><span class="line">S|access:21</span><br><span class="line">S|open:2</span><br><span class="line">SysEnter|syscall_open|0x7f5ec47dbd60|0x80000|</span><br><span class="line"> 	arg 0: /lib/x86_64-linux-gnu/libselinux.so.1 (type=char*, size=0x0)</span><br><span class="line"> 	arg 1: 0x80000 (type=long, size=0x8)</span><br><span class="line">SysExit|open</span><br><span class="line">S|read:0</span><br><span class="line">SysEnter|syscall_read|0x3|0x7ffda586ce38|0x340|</span><br><span class="line"> 	arg 0: 0x3 (type=long, size=0x8)</span><br><span class="line"> 	arg 2: 0x340 (type=int, size=0x4)</span><br><span class="line">SysExit|read</span><br><span class="line"> 	arg 1: 0x7ffda586ce38</span><br><span class="line">000000: 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span><br><span class="line">000010: 03 00 3e 00 01 00 00 00 b0 5a 00 00 00 00 00 00  ..&gt;......Z......</span><br><span class="line">000020: 40 00 00 00 00 00 00 00 30 f5 01 00 00 00 00 00  @.......0.......</span><br><span class="line">000030: 00 00 00 00 40 00 38 00 08 00 40 00 1e 00 1d 00  ....@.8...@.....</span><br><span class="line">000040: 01 00 00 00 05 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>如果不需要记录syscall调用，同样设置syscall参数为0即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -syscall  0 -- ls -al</span><br></pre></td></tr></table></figure>

<h3 id="2-3-指令运行状态记录"><a href="#2-3-指令运行状态记录" class="headerlink" title="2.3 指令运行状态记录"></a>2.3 指令运行状态记录</h3><p>功能类似hutrace，开启指令状态记录时则不需要再记录bbllog功能中的指令反汇编结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -inslog -- ls -al</span><br></pre></td></tr></table></figure>

<p>trace的部分日志结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">B0x402a00|0x402a2c</span><br><span class="line">	I0x402a00|push r15                                   | M:0x7fffffffd930 | D:0x0 | r15:0x0</span><br><span class="line">	I0x402a02|push r14                                   | M:0x7fffffffd928 | D:0x0 | r14:0x0</span><br><span class="line">	I0x402a04|push r13                                   | M:0x7fffffffd920 | D:0x7fffffffda10 | r13:0x7fffffffda10</span><br><span class="line">	I0x402a06|push r12                                   | M:0x7fffffffd918 | D:0x4049a0 | r12:0x4049a0</span><br><span class="line">	I0x402a08|push rbp                                   | M:0x7fffffffd910 | D:0x413bb0 | rbp:0x413bb0</span><br><span class="line">	I0x402a09|push rbx                                   | M:0x7fffffffd908 | D:0x0 | rbx:0x0</span><br><span class="line">	I0x402a0a|mov ebx, edi                               | rdi:0x2 | rbx:0x0 </span><br><span class="line">	I0x402a0c|mov rbp, rsi                               | rsi:0x7fffffffda18 | rbp:0x413bb0 </span><br><span class="line">	I0x402a0f|sub rsp, 0x388                             | rsp:0x7fffffffd908 </span><br><span class="line">	I0x402a16|mov rdi, qword ptr [rsi]                   | M:0x7fffffffda18 | D:0x7fffffffddeb | rdi:0x2</span><br><span class="line">	I0x402a19|mov rax, qword ptr fs:[0x28]               | M:0x7fffe39a3828 | D:0x8cde58e761386e00 | rax:0x402a00</span><br><span class="line">	I0x402a22|mov qword ptr [rsp+0x378], rax             | M:0x7fffffffd8f8 | D:0x413bfd | rax:0x8cde58e761386e00</span><br><span class="line">	I0x402a2a|xor eax, eax                               | rax:0x8cde58e761386e00 </span><br><span class="line">C0x402a2c|0x40db00</span><br><span class="line">	I0x402a2c|call 0x40db00                              | M:0x7fffffffd578 | D:0x7fffe46f84e8</span><br></pre></td></tr></table></figure>

<h3 id="2-4-指定trace指令起始、结束地址"><a href="#2-4-指定trace指令起始、结束地址" class="headerlink" title="2.4 指定trace指令起始、结束地址"></a>2.4 指定trace指令起始、结束地址</h3><p>指定需要trace的指令范围，需要设置为基本块的开始或结束地址(为了便于展示，可以取消全局的syscall调用打印)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -inslog -logstart 0x402a00 -logend 0x402c7c -syscall 0 -- ls -al</span><br></pre></td></tr></table></figure>

<p>trace的结果信息中只会打印到0x402c7c的前一个基本块信息结束，并不会打印0x402c7c所在基本块的指令信息等。</p>
<h3 id="2-5-指定需要trace的模块"><a href="#2-5-指定需要trace的模块" class="headerlink" title="2.5 指定需要trace的模块"></a>2.5 指定需要trace的模块</h3><p>利用target参数指定需要trace的模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -inslog -target mytestso.so -syscall 0 -- ./test.out</span><br></pre></td></tr></table></figure>

<p>trace得到的部分结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~~25933~~ libdl.so.2!dlsym N:0x7</span><br><span class="line"> 	arg 0: 0x555555756030 (type=long, size=0x8)</span><br><span class="line"> 	arg 1: my_main (type=char*, size=0x0)</span><br><span class="line">   executed libdl.so.2!dlsym returnIp:0x5555555548cb =&gt;</span><br><span class="line"> 	retval: 0x7fffe36f460a (type=int, size=0x4)</span><br><span class="line">//得到mytestso.so!my_main的函数地址</span><br><span class="line"></span><br><span class="line">B0x5555555548cb|0x5555555548e2</span><br><span class="line">	I0x5555555548cb|mov qword ptr [rbp-0x10], rax              | M:0x7fffffffd920 | D:0x0 | rax:0x7fffe36f460a</span><br><span class="line">	I0x5555555548cf|mov rax, qword ptr [rbp-0x10]              | M:0x7fffffffd920 | D:0x7fffe36f460a | rax:0x7fffe36f460a</span><br><span class="line">	I0x5555555548d3|mov edx, 0x3                               | rdx:0x1 </span><br><span class="line">	I0x5555555548d8|mov esi, 0x2                               | rsi:0x7fffe471a0d8 </span><br><span class="line">	I0x5555555548dd|mov edi, 0x1                               | rdi:0x7ffff7ffd948 </span><br><span class="line">C0x5555555548e2|0x7fffe36f460a</span><br><span class="line">	I0x5555555548e2|call rax                                   | M:0x7fffffffd918 | D:0x5555555548cb | rax:0x7fffe36f460a</span><br><span class="line">~~25933~~ mytestso.so!my_main N:0x8</span><br><span class="line">	arg 0: 0x1</span><br><span class="line">	arg 1: 0x2</span><br><span class="line">	arg 2: 0x3</span><br><span class="line">	arg 3: 0x0</span><br><span class="line">B0x7fffe36f460a|0x7fffe36f4622</span><br><span class="line">	I0x7fffe36f460a|push rbp                                   | M:0x7fffffffd910 | D:0x7fffffffd930 | rbp:0x7fffffffd930</span><br><span class="line">	I0x7fffe36f460b|mov rbp, rsp                               | rsp:0x7fffffffd910 | rbp:0x7fffffffd930 </span><br><span class="line">	I0x7fffe36f460e|sub rsp, 0x10                              | rsp:0x7fffffffd910 </span><br><span class="line">	I0x7fffe36f4612|mov dword ptr [rbp-0x4], edi               | M:0x7fffffffd90c | D:0xffffd93000000000 | rdi:0x1</span><br><span class="line">	I0x7fffe36f4615|mov dword ptr [rbp-0x8], esi               | M:0x7fffffffd908 | D:0x100000000 | rsi:0x2</span><br><span class="line">	I0x7fffe36f4618|mov dword ptr [rbp-0xc], edx               | M:0x7fffffffd904 | D:0x200005555 | rdx:0x3</span><br><span class="line">	I0x7fffe36f461b|lea rdi, ptr [rip+0x1f]                    | rip:0x7fffe36f461b | rdi:0x1</span><br></pre></td></tr></table></figure>

<h2 id="3-其它功能"><a href="#3-其它功能" class="headerlink" title="3. 其它功能"></a>3. 其它功能</h2><h3 id="3-1-任意地址hook插件"><a href="#3-1-任意地址hook插件" class="headerlink" title="3.1 任意地址hook插件"></a>3.1 任意地址hook插件</h3><p>这里继续使用hutrace的linux应用文章中的例子进行演示，将原本程序中打印函数的参数从1-8修改为11-18，首先在hzytrace_linux.config设置需要hook的地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook|0x400706</span><br></pre></td></tr></table></figure>
<p>在hzytrace中简化了插件的加载和调用方式，只需要设置需要hook的的地址即可，而且不支持hutrace提供的函数开始、结束同时hook，如果有类似需求，可以在返回地址处添加新的返回地址hook条目，hzytrace运行到0x400706地址处时会加载mypinplugin.so并调用导出函数名为f_hookpre_0x400706的导出函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">int  f_hookpre_0x400706(bluepill_tls *tdata,ADDRINT *r_RDI,ADDRINT *r_RSI,ADDRINT *r_RDX,ADDRINT *r_RCX,ADDRINT *r_R8,ADDRINT *r_R9,ADDRINT *r_RAX,ADDRINT *r_RBX,ADDRINT *r_RBP,ADDRINT *r_RSP,ADDRINT *r_R10,ADDRINT *r_R11,ADDRINT *r_R12,ADDRINT *r_R13,ADDRINT *r_R14,ADDRINT *r_R15)</span><br><span class="line">&#123;</span><br><span class="line">	*r_RDI = 11;</span><br><span class="line">	*r_RSI = 12;</span><br><span class="line">	*r_RDX = 13;</span><br><span class="line">	*r_RCX = 14;</span><br><span class="line">	*r_R8 = 15;</span><br><span class="line">	*r_R9 = 16;</span><br><span class="line">	*(ADDRINT *)(*r_RSP + (7-6) * 8) = 17;</span><br><span class="line">	*(ADDRINT *)(*r_RSP + (8-6) * 8) = 18;</span><br><span class="line">	//写入到trace的log日志中</span><br><span class="line">	(*tdata-&gt;file_write)(tdata-&gt;threadid, tdata-&gt;buffer, tdata-&gt;OutFile, &quot;[hook]|test r_RDI:%p\n&quot;,*r_RDI);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mypinplugin.so编译时可以使用以下编译选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//x64</span><br><span class="line">g++ -fPIC -shared -o mypinplugin.so mypinPlugin.cpp  -m64 -D X86_64 -Wl,--hash-style=sysv</span><br><span class="line">//x32</span><br><span class="line">g++ -fPIC -shared -o mypinplugin.so mypinPlugin.cpp  -m32 -D X86_32 -Wl,--hash-style=sysv</span><br></pre></td></tr></table></figure>
<p>同时注意因为pin的限制，插件中无法引用其它系统的libc.so文件，故不建议在hook函数中引用api函数实现较为复杂的功能，如果确有此类需求，可以尝试编译成静态的so文件或者编译一个main函数为空、仅导出功能函数的pin插件加载，使用hutrace则不受此限制。</p>
<h3 id="3-2-内存dump功能"><a href="#3-2-内存dump功能" class="headerlink" title="3.2 内存dump功能"></a>3.2 内存dump功能</h3><p>根据hzytrace在运行时输出的调试信息中测试程序soTest加载后的代码范围0x400000-400b43，来演示下hzytrace的内存dump功能，在hzytrace_linux.config设置需要dump的时机以及需要dump的内存地址以及内存大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump|0x400706|0x400000|0xb43</span><br></pre></td></tr></table></figure>
<p>同样设置代码运行到0x400706时dump地址从0x400000开始大小为0xb43字节的内存数据，运行测试程序后，在Result目录中对应的日志记录文件夹中生成内存dump文件。</p>
<ul>
<li><p>dump功能可以和hook功能指定同一个地址，即可执行到该地址后进行dump操作，又可以在当前地址处使用hook功能加载插件（hutrace则不支持）。</p>
</li>
<li><p>dump功能同样可以在不同运行地址状态指定相同地址范围的内存进行提取，dump的文件名结尾会进行累加，可以比对不同状态下内存状态信息改变情况。</p>
</li>
</ul>
<h2 id="4-实例演示"><a href="#4-实例演示" class="headerlink" title="4. 实例演示"></a>4. 实例演示</h2><p><img src="%E5%9B%BE%E7%89%872.png" alt=""></p>
<h3 id="4-1-hide"><a href="#4-1-hide" class="headerlink" title="4.1 hide"></a>4.1 hide</h3><p>来看一个几年前qwb里ling博狗的例子“hide”，用了upx壳并且修改了一些upx标识，无法自动脱壳，程序本身使用了ptrace的PTRACE_TRACEME反调试（使用strace跟踪会退出），而且本身程序使用syscall完成读写、还使用了一处虚假的flag校验函数进行混淆，常规方式可以使用“catch syscall ptrace”逐步定位关键代码处，下面我们尝试使用hzytrace处理类似程序（hutrace虽然可以正常处理upx和PTRACE_TRACEME，但是这个程序无法正常trace，原因没有深入研究）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># huhu @ huhu in ~/Desktop/pin-3.5 [7:30:39] </span><br><span class="line">$ ./pin -t hzytrace.so -bbllog -- ./hide</span><br><span class="line">[INFO] Configuring Pintool</span><br><span class="line">[INFO] Starting instrumented program</span><br><span class="line"></span><br><span class="line">[INFO] Opening file</span><br><span class="line">./Results/2022_05_26_07_31_43//TRACER/hzytrace.hide.37360.0.1653568303.out</span><br><span class="line">Enter the flag:</span><br><span class="line">1234567890</span><br><span class="line">You are wrong</span><br></pre></td></tr></table></figure>
<p>查看日志直接搜索输入的“1234567890”（trace的日志500m文件使用010edit秒搜）：</p>
<p><img src="%E5%9B%BE%E7%89%873.png" alt=""></p>
<p>因为hzytrace仅对运行的代码进行记录，下面把这段内存进行dump拖进ida里查看完整的代码逻辑，在hzytrace_linux.config中设置执行到0x4c8eeb代码处时自动dump地址为0x400000代码处的内存（可设置关闭aslr固定内存地址）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump|0x4c8eeb|0x400000|0xca000</span><br></pre></td></tr></table></figure>
<p>再次运行在对应的result日志目录生成内存dump文件，拖进ida，查看上述记录的日志中对应代码：</p>
<p><img src="%E5%9B%BE%E7%89%874.png" alt=""></p>
<p>后面分析算法既可以ida静态，也可使用hzytrace的inslog参数追踪代码执行过程的寄存器及内存信息辅助分析算法，亦可使用gdb根据日志中的ptrace调用信息对其反调试进行绕过并继续调试，不再赘述。</p>
<h3 id="4-2-bytepacker"><a href="#4-2-bytepacker" class="headerlink" title="4.2 bytepacker"></a>4.2 bytepacker</h3><p>这个程序来自某次分享的ctf赛题，使用双进程方式进行反调试，但是没有使用特别复杂的debugblock方式，所以依旧可以使用hzytrace进行指令流的trace（bbllog功能），但是无法使用inslog功能，全指令插桩会影响其执行流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./pin -t hzytrace.so -bbllog -- ./bytepacker</span><br><span class="line">[INFO] Configuring Pintool</span><br><span class="line">[INFO] Starting instrumented program</span><br><span class="line"></span><br><span class="line">[INFO] Opening file</span><br><span class="line">./Results/2022_05_29_08_46_16//TRACER/hzytrace.bytepacker.47505.0.1653831976.out</span><br><span class="line">[INFO] Fork New Process</span><br><span class="line">[INFO] Opening file</span><br><span class="line">./Results/2022_05_29_08_46_16//TRACER/hzytrace.bytepacker.47509.0.1653831976.out</span><br><span class="line">Show me the flag:</span><br><span class="line">&gt;&gt; 1234567890</span><br><span class="line">No, not this one.%</span><br></pre></td></tr></table></figure>
<p>同样可以在trace的日志中直接搜索到使用syscall方式读取输入的测试flag的代码位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">B0x7fffe42f6359|0x7fffe42f635e</span><br><span class="line">	D0x7fffe42f6359|mov eax, 0x0</span><br><span class="line">	D0x7fffe42f635e|syscall </span><br><span class="line">S|read:0</span><br><span class="line">SysEnter|syscall_read|0x0|0x7ffff7fff420|0x400|</span><br><span class="line"> 	arg 0: &lt;null&gt; (type=long, size=0x8)</span><br><span class="line"> 	arg 2: 0x400 (type=int, size=0x4)</span><br><span class="line">SysExit|read</span><br><span class="line"> 	arg 1: 0x7ffff7fff420</span><br><span class="line">000000: 31 32 33 34 35 36 37 38 39 30 30 0a 00 00 00 00  12345678900.....</span><br><span class="line">......//省略部分显示</span><br><span class="line"> (type=__out hex^ARG2*, size=0x400)</span><br><span class="line">B0x7fffe42f6360|0x7fffe42f6366</span><br><span class="line">	D0x7fffe42f6360|cmp rax, 0xfffffffffffff001</span><br><span class="line">	D0x7fffe42f6366|jnb 0x7fffe42f6399</span><br><span class="line">......//省略部分显示</span><br><span class="line">B0x7fffe42f63b0|0x7fffe42f63b7</span><br><span class="line">	D0x7fffe42f63b0|cmp dword ptr [rip+0x2d2389], 0x0</span><br><span class="line">	D0x7fffe42f63b7|jnz 0x7fffe42f63c9</span><br><span class="line">B0x7fffe42f63b9|0x7fffe42f63be</span><br><span class="line">	D0x7fffe42f63b9|mov eax, 0x1</span><br><span class="line">	D0x7fffe42f63be|syscall </span><br><span class="line">S|write:1</span><br><span class="line">SysEnter|syscall_write|0x1|0x7ffff7fff010|</span><br><span class="line"> 	arg 0: 0x1 (type=long, size=0x8)</span><br><span class="line"> 	arg 1: No, not this one.5;74mflag[m:</span><br><span class="line"> (type=char*, size=0x0)</span><br><span class="line">SysExit|write</span><br></pre></td></tr></table></figure>
<p>在hzytrace_linux.config中设置dump内存(关闭aslr的情况下，查看0x7fffe42f6360代码所在内存范围，确保内存地址固定)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump|0x7fffe42f6360|0x7fffe41f7000|0x1c0000</span><br></pre></td></tr></table></figure>
<p>后续可以据此静态分析,同样也可以向上述hide一样对照trace日志中父进程对子进程的操作进行针对性的处理，只是不能支持inslog功能打印寄存器及引用的内存状态了，父进程的处理代码地址可简单定位如下：</p>
<p><img src="%E5%9B%BE%E7%89%875.png" alt=""></p>
<p>实际上像一些更复杂的debugblock代码等使用hzytrace处理子进程时也会崩溃，有的情况下可以通过pin提供的接口对其进行绕过，但是代价略大点，同样后续有好的方案了会进行更新。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>前面的文章中提到hzytrace一个主要目的是为了应对linux平台下一些程序无法使用hutrace处理的问题，当然不止是上面提到的一些小众的ctf赛题，pin的接口相对更为丰富，hzytrace也只是相对hutrace稍微简化了下，功能整体来说保持一致。</p>
<p>github地址：<a href="https://github.com/huhu0706/hzytrace" target="_blank" rel="noopener">https://github.com/huhu0706/hzytrace</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag"># 工具</a>
              <a href="/tags/%E8%B0%83%E8%AF%95%E5%99%A8/" rel="tag"># 调试器</a>
              <a href="/tags/hutrace/" rel="tag"># hutrace</a>
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/pin/" rel="tag"># pin</a>
              <a href="/tags/hzytrace/" rel="tag"># hzytrace</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2022/06/06/2022-06-06-hutrace%E5%B7%A5%E5%85%B7%E7%B3%BB%E5%88%97%E7%AC%AC3%E7%AF%87%E4%B9%8BLinux%E5%BA%94%E7%94%A8/" rel="next" title="2022-06-06-hutrace工具系列第3篇之Linux应用">
                  <i class="fa fa-chevron-left"></i> 2022-06-06-hutrace工具系列第3篇之Linux应用
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-简介"><span class="nav-number">1.</span> <span class="nav-text">1. 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-基本功能"><span class="nav-number">2.</span> <span class="nav-text">2. 基本功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-基本块汇编指令打印"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 基本块汇编指令打印</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-syscall记录"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 syscall记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-指令运行状态记录"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 指令运行状态记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-指定trace指令起始、结束地址"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 指定trace指令起始、结束地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-指定需要trace的模块"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 指定需要trace的模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-其它功能"><span class="nav-number">3.</span> <span class="nav-text">3. 其它功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-任意地址hook插件"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 任意地址hook插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-内存dump功能"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 内存dump功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-实例演示"><span class="nav-number">4.</span> <span class="nav-text">4. 实例演示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-hide"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 hide</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-bytepacker"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 bytepacker</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-总结"><span class="nav-number">5.</span> <span class="nav-text">5. 总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="huhu"
    src="/images/main.gif">
  <p class="site-author-name" itemprop="name">huhu</p>
  <div class="site-description" itemprop="description">悟已往之不谏、知来者之可追</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/huhu0706" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;huhu0706" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hu-qqchoi@qq.com" title="E-Mail &amp;rarr; mailto:hu-qqchoi@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">huhu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">166k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:31</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script>



  






  <script src="/js/local-search.js?v=7.4.2"></script>













  

  

  

</body>
</html>
